<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Data Collector</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
      color: #495057;
    }
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <h2>ğŸ“¡ è®¾å¤‡æ•°æ®è‡ªåŠ¨ä¸ŠæŠ¥</h2>
  <p id="info">æ­£åœ¨å¤„ç†...</p>
  <div id="status" class="loading">è¯·ç¨å€™...</div>

  <script>
    // 1. ä» URL è·å–å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const device = urlParams.get('device') || '';
    const ble_addr = urlParams.get('ble_addr') || '';
    const jingwei = urlParams.get('jingwei') || '';

    if (!device || !ble_addr) {
      document.getElementById('info').textContent = 'âŒ ç¼ºå°‘å¿…è¦å‚æ•°';
      document.getElementById('status').className = 'status';
      document.getElementById('status').textContent = 'è¯·æ£€æŸ¥ URL';
    } else {
      // 2. å‘é€æ•°æ®åˆ°åç«¯ï¼ˆç°åœ¨åç«¯ä¼šè‡ªåŠ¨å»é‡ + è¿”å›æ€»æ•°ï¼‰
      fetch('/api/user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device, ble_addr, jingwei })
      })
      .then(res => res.json())
      .then(data => {
        const infoEl = document.getElementById('info');
        const statusEl = document.getElementById('status');

        if (data.error) {
          infoEl.textContent = `è®¾å¤‡: ${device} | BLE: ${ble_addr}`;
          statusEl.className = 'status';
          statusEl.textContent = `âŒ ${data.error}`;
        } else {
          infoEl.textContent = `è®¾å¤‡: ${device} | BLE: ${ble_addr}`;
          statusEl.className = 'success';
          if (data.inserted) {
            statusEl.textContent = `âœ… æ–°è®¾å¤‡å·²è®°å½•ï¼`;
          } else {
            statusEl.textContent = `â„¹ï¸ è®¾å¤‡å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤è®°å½•ã€‚`;
          }
          // æ˜¾ç¤ºæ€»è®¾å¤‡æ•°
          document.body.innerHTML += `<div style="margin-top:20px;font-size:18px;color:#28a745;">ğŸ“Š å½“å‰å…± <strong>${data.total}</strong> å°è®¾å¤‡</div>`;
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('status').className = 'status';
        document.getElementById('status').textContent = 'âŒ ç½‘ç»œé”™è¯¯';
      });
    }
  </script>
</body>
</html>

