<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Data Collector</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
      color: #495057;
    }
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <h2>ğŸ“¡ è®¾å¤‡æ•°æ®è‡ªåŠ¨ä¸ŠæŠ¥</h2>
  <p id="info">æ­£åœ¨è¯»å–è®¾å¤‡ä¿¡æ¯...</p>
  <div id="status" class="loading">å‡†å¤‡ä¸ŠæŠ¥æ•°æ®...</div>

  <script>
    // 1. ä» URL æŸ¥è¯¢å‚æ•°ä¸­æå–æ•°æ®
    const urlParams = new URLSearchParams(window.location.search);
    const device = urlParams.get('device') || '';
    const ble_addr = urlParams.get('ble_addr') || ''; // æ³¨æ„ï¼šä½ å†™çš„æ˜¯ bel_addrï¼Œä½†åº”è¯¥æ˜¯ ble_addrï¼Ÿ
    const jingwei = urlParams.get('jingwei') || '';

    // æ˜¾ç¤ºå½“å‰è¯»å–åˆ°çš„ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œä¸Šçº¿åå¯åˆ é™¤ï¼‰
    document.getElementById('info').textContent = 
      `è®¾å¤‡: ${device} | BLE: ${ble_addr} | ç»çº¬åº¦: ${jingwei}`;

    // 2. å¦‚æœå¿…è¦å‚æ•°ç¼ºå¤±ï¼Œåœæ­¢ä¸ŠæŠ¥
    if (!device || !ble_addr) {
      document.getElementById('status').className = 'error';
      document.getElementById('status').textContent = 'âŒ ç¼ºå°‘å¿…è¦å‚æ•°ï¼ˆdevice æˆ– ble_addrï¼‰';
    } else {
      // 3. è‡ªåŠ¨å‘é€æ•°æ®åˆ°åç«¯ API
      fetch('/api/user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device, ble_addr, jingwei })
      })
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById('status');
        if (data.success) {
          statusEl.className = 'success';
          statusEl.textContent = 'âœ… æ•°æ®å·²æˆåŠŸä¸ŠæŠ¥ï¼';
        } else {
          throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');
        }
      })
      .catch(err => {
        console.error('ä¸ŠæŠ¥å¤±è´¥:', err);
        document.getElementById('status').className = 'error';
        document.getElementById('status').textContent = 'âŒ ä¸ŠæŠ¥å¤±è´¥ï¼š' + err.message;
      });
    }
  </script>
</body>
</html>

